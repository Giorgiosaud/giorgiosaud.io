---
import AdminLayout from '@components/admin/AdminLayout.astro'
import { db } from '@db'
import { eq } from 'drizzle-orm'
import { pushSubscriptions } from '@db/schema'

export const prerender = false

const activeSubscriptions = await db.query.pushSubscriptions.findMany({
  where: eq(pushSubscriptions.isActive, true),
})

const subscriberCount = activeSubscriptions.length
---

<AdminLayout title="Notifications" currentPage="notifications">
  <section class="broadcast-section">
    <h2>Send Broadcast Notification</h2>
    <p class="subtitle">Send to all {subscriberCount} subscriber{subscriberCount !== 1 ? 's' : ''}</p>

    <form id="broadcast-form">
      <div class="form-group">
        <label for="title">Title</label>
        <input type="text" id="title" name="title" required maxlength="50" placeholder="New blog post!" />
      </div>

      <div class="form-group">
        <label for="body">Message</label>
        <textarea id="body" name="body" required maxlength="200" rows="3" placeholder="Check out my latest article..."></textarea>
      </div>

      <div class="form-group">
        <label for="url">Link URL (optional)</label>
        <input type="text" id="url" name="url" placeholder="/notebook/my-new-post" />
      </div>

      <button type="submit" class="btn-primary">
        Send Broadcast
      </button>
    </form>

    <div id="result" class="result" hidden></div>
  </section>
</AdminLayout>

<script>
  const form = document.getElementById('broadcast-form') as HTMLFormElement
  const resultDiv = document.getElementById('result') as HTMLDivElement

  form?.addEventListener('submit', async (e) => {
    e.preventDefault()

    const formData = new FormData(form)
    const title = formData.get('title') as string
    const body = formData.get('body') as string
    const url = formData.get('url') as string

    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement
    submitBtn.disabled = true
    submitBtn.textContent = 'Sending...'

    try {
      const payload: { type: string; title: string; body: string; url?: string } = { type: 'custom', title, body }
      if (url) payload.url = url

      const response = await fetch('/api/push/broadcast.json', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      })

      const data = await response.json()

      resultDiv.hidden = false
      if (response.ok) {
        resultDiv.className = 'result success'
        resultDiv.textContent = `Sent to ${data.result.sent} subscriber(s). ${data.result.failed} failed.`
        form.reset()
      } else {
        resultDiv.className = 'result error'
        resultDiv.textContent = data.error || 'Failed to send broadcast'
      }
    } catch {
      resultDiv.hidden = false
      resultDiv.className = 'result error'
      resultDiv.textContent = 'Network error. Please try again.'
    } finally {
      submitBtn.disabled = false
      submitBtn.textContent = 'Send Broadcast'
    }
  })
</script>

<style>
  .broadcast-section {
    max-width: 500px;
  }

  h2 {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
  }

  .subtitle {
    color: var(--color-muted, #666);
    margin-bottom: 1.5rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: 500;
  }

  input, textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid var(--color-border, #ddd);
    border-radius: 4px;
    font-family: inherit;
    font-size: 1rem;
  }

  .btn-primary {
    width: 100%;
    padding: 0.75rem;
    background: var(--color-main);
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .btn-primary:hover:not(:disabled) {
    opacity: 0.9;
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .result {
    margin-top: 1rem;
    padding: 0.75rem;
    border-radius: 4px;
    text-align: center;
  }

  .result.success {
    background: var(--color-success, #10b981);
    color: white;
  }

  .result.error {
    background: var(--color-error, #ef4444);
    color: white;
  }
</style>
