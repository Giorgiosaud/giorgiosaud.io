---
import AdminLayout from '@components/admin/AdminLayout.astro'
import { db } from '@db'
import { isNull, desc } from 'drizzle-orm'
import { comments } from '@db/schema'

export const prerender = false

const allComments = await db.query.comments.findMany({
  where: isNull(comments.deletedAt),
  orderBy: [desc(comments.createdAt)],
  limit: 50,
  with: { author: true },
})
---

<AdminLayout title="Comments" currentPage="comments">
  <section class="comments-section">
    <header class="section-header">
      <h2>Comments ({allComments.length})</h2>
    </header>

    {allComments.length === 0 ? (
      <p class="empty">No comments yet.</p>
    ) : (
      <ul class="comment-list">
        {allComments.map(comment => (
          <li class="comment-item" data-id={comment.id}>
            <div class="comment-header">
              <div class="comment-author">
                <strong>{comment.author?.name || 'Unknown'}</strong>
                <span class="comment-email">{comment.author?.email}</span>
              </div>
              <span class="comment-date">{new Date(comment.createdAt).toLocaleString()}</span>
            </div>
            <p class="comment-content">{comment.content}</p>
            <div class="comment-footer">
              <span class="comment-meta">Post: {comment.noteSelfHealing}</span>
              <div class="comment-actions">
                <button type="button" class="btn-small btn-danger" onclick={`deleteComment('${comment.id}')`}>
                  Delete
                </button>
              </div>
            </div>
          </li>
        ))}
      </ul>
    )}

    <div id="result" class="result" hidden></div>
  </section>
</AdminLayout>

<script>
  window.deleteComment = async (id: string) => {
    if (!confirm('Delete this comment?')) return

    const result = document.getElementById('result') as HTMLDivElement

    try {
      const response = await fetch(`/api/admin/comments/${id}.json`, { method: 'DELETE' })
      const data = await response.json()

      result.hidden = false
      result.className = response.ok ? 'result success' : 'result error'
      result.textContent = response.ok ? 'Comment deleted' : (data.error || 'Failed to delete')

      if (response.ok) {
        document.querySelector(`.comment-item[data-id="${id}"]`)?.remove()
      }
    } catch {
      result.hidden = false
      result.className = 'result error'
      result.textContent = 'Network error'
    }
  }

  declare global {
    interface Window {
      deleteComment: (id: string) => Promise<void>
    }
  }
</script>

<style>
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  h2 {
    font-size: 1.25rem;
    margin: 0;
  }

  .empty {
    color: var(--color-muted, #666);
    font-style: italic;
  }

  .comment-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .comment-item {
    padding: 1rem;
    border: 1px solid var(--color-border, #ddd);
    border-radius: 8px;
    margin-bottom: 0.75rem;
  }

  .comment-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
  }

  .comment-author {
    display: flex;
    flex-direction: column;
  }

  .comment-email {
    font-size: 0.75rem;
    color: var(--color-muted, #666);
  }

  .comment-date {
    font-size: 0.75rem;
    color: var(--color-muted, #666);
  }

  .comment-content {
    margin: 0.75rem 0;
    line-height: 1.5;
  }

  .comment-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .comment-meta {
    font-size: 0.75rem;
    color: var(--color-muted, #666);
  }

  .comment-actions {
    display: flex;
    gap: 0.5rem;
  }

  .btn-small {
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  .btn-danger {
    background: var(--color-error, #ef4444);
    color: white;
  }

  .btn-danger:hover {
    opacity: 0.9;
  }

  .result {
    margin-top: 1rem;
    padding: 0.75rem;
    border-radius: 4px;
    text-align: center;
  }

  .result.success {
    background: var(--color-success, #10b981);
    color: white;
  }

  .result.error {
    background: var(--color-error, #ef4444);
    color: white;
  }
</style>
