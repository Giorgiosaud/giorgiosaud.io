---
import { getLangFromUrl } from '@i18n/utils'
import Favicons from './Favicons.astro'
import PWA from './PWA.astro'

// Self-hosted fonts via fontsource (faster, no external requests)
import '@fontsource/poppins/400.css'
import '@fontsource/poppins/500.css'
import '@fontsource/poppins/600.css'
import '@fontsource/poppins/700.css'
import '@fontsource/roboto-mono/400.css'
import '@fontsource/roboto-mono/500.css'

// Import font files for preloading (breaks critical request chain)
import poppins400 from '@fontsource/poppins/files/poppins-latin-400-normal.woff2?url'
import poppins600 from '@fontsource/poppins/files/poppins-latin-600-normal.woff2?url'
import poppins700 from '@fontsource/poppins/files/poppins-latin-700-normal.woff2?url'

// Font metrics fallback to prevent CLS during font swap
const fontMetricsFallback = `
@font-face {
  font-family: 'Poppins Fallback';
  src: local('Arial');
  size-adjust: 112%;
  ascent-override: 105%;
  descent-override: 35%;
  line-gap-override: 10%;
}
`

export interface Props {
  title?: string
  description?: string
  structuredData?: string
  image?: string | ImageMetadata
}
const {
  title,
  structuredData,
  description = 'This is a web developers Notebook site',
  image = 'https://giorgiosaud.io/opengraph.jpg',
} = Astro.props
const imageUrl = typeof image === 'string' ? image : image?.src || ''
const fixedTitle = `Giorgiosaud.io | ${title || 'Notebook'}`
const lang = getLangFromUrl(Astro.url)
---
<head>
  <!-- Preload critical fonts to break request chain -->
  <link rel="preload" href={poppins400} as="font" type="font/woff2" crossorigin="anonymous" />
  <link rel="preload" href={poppins600} as="font" type="font/woff2" crossorigin="anonymous" />
  <link rel="preload" href={poppins700} as="font" type="font/woff2" crossorigin="anonymous" />

  <!-- Font metrics fallback to prevent CLS -->
  <style set:html={fontMetricsFallback}></style>

  <!-- Google Tag Manager - Deferred for better LCP -->
  <script>
    import { TAG_MANAGER_ID } from "astro:env/client";

    // Initialize dataLayer for custom events
    declare global {
      interface Window {
        dataLayer: Record<string, unknown>[];
      }
    }
    window.dataLayer = window.dataLayer || [];

    // Defer GTM loading until after page load or user interaction
    const loadGTM = () => {
      if ((window as any).gtmLoaded) return;
      (window as any).gtmLoaded = true;

      const script = document.createElement('script');
      script.async = true;
      script.src = `https://www.googletagmanager.com/gtm.js?id=${TAG_MANAGER_ID || ''}`;
      document.head.appendChild(script);

      window.dataLayer.push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
    };

    // Load GTM after page is interactive or on first user interaction
    if (document.readyState === 'complete') {
      setTimeout(loadGTM, 2000);
    } else {
      window.addEventListener('load', () => setTimeout(loadGTM, 2000));
    }

    // Also load on first user interaction for faster tracking
    ['click', 'scroll', 'keydown', 'touchstart'].forEach(event => {
      document.addEventListener(event, loadGTM, { once: true, passive: true });
    });
  </script>
  <!-- End Google Tag Manager -->
  <meta charset="UTF-8" />
  <meta
  content="width=device-width, initial-scale=1.0"
  name="viewport"
  />
  <meta
  content="Jorge Saud"
  name="author"
  />
  <meta
  content={Astro.generator}
  name="generator"
  />
  <meta name="description" content={description}>
  <slot name="meta" />
  
  <title>{fixedTitle}</title>

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content={fixedTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url || 'https://giorgiosaud.io/'} />
    <meta property="og:image" content={imageUrl} />
    <meta property="og:site_name" content="Giorgiosaud.io" />
    <meta property="og:locale" content={lang=='en'?'en_US':'es_VE'} />
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={fixedTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={imageUrl} />
    <meta name="twitter:site" content="@giorgiosaud" />
  <Favicons/>
  <PWA />
  <link
  href="/sitemap-index.xml"
  rel="sitemap"
  />
  <script type="speculationrules">
    {
      "prerender": [
      {
        "source": "document",
        "where": {
          "and": [
          { 
            "href_matches": "/*" 
          },
          { 
            "not": {
              "href_matches": "/logout/*" 
            } 
          }
          ]
        },
        "eagerness": "moderate"
      }
      ]
    }
  </script>
  {
    structuredData &&
    <script type="application/ld+json" set:html={structuredData}>
    </script>
  }
  <meta name="robots" content="index, follow" />
  <meta name="theme-color" content="#22223b" />
  <link rel="apple-touch-icon" href="/icons/apple-icon.png" />
  <link rel="alternate" href="https://giorgiosaud.io/" hreflang="en" />
<link rel="alternate" href="https://giorgiosaud.io/es/" hreflang="es" />
</head>