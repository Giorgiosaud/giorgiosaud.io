---
interface Props {
  lang?: "en" | "es";
}

const { lang = "en" } = Astro.props;

const i18n = {
  en: {
    buttonTitle: "Generate summary",
    loading: "Generating Summary...",
    unavailable: "The summarization API is not available in this browser.",
    inputLang: "en",
    outputLang: "en",
    streamLang: "en",
  },
  es: {
    buttonTitle: "Generar resumen",
    loading: "Generando resumen...",
    unavailable: "La API de resumen no estÃ¡ disponible en este navegador.",
    inputLang: "es",
    outputLang: "es",
    streamLang: "es",
  },
};

const t = i18n[lang];
---

<!-- Floating bubble button for summary generation (hidden until API is available) -->
<button
  id="generate-summary-bubble"
  class="summary-bubble"
  title={t.buttonTitle}
  hidden
>
  <span>ðŸ¤–</span>
</button>

<!-- Emergent bubble/modal for summary result -->
<div id="summary-modal" class="summary-modal" hidden>
  <button id="close-summary-modal" class="close-summary-modal">&times;</button>
  <div id="summary-content"></div>
</div>

<script define:vars={{ t }}>
  if ("Summarizer" in self) {
    const summaryBubble = document.getElementById("generate-summary-bubble");
    const summaryModal = document.getElementById("summary-modal");
    const summaryContent = document.getElementById("summary-content");
    const closeModalBtn = document.getElementById("close-summary-modal");

    // Show the summarizer button only when API is available
    summaryBubble.hidden = false;
    summaryModal.hidden = false;

    // Cache for lazy-loaded marked library
    let markedModule = null;

    async function getMarked() {
      if (!markedModule) {
        const module =
          await import("https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js");
        markedModule = module.marked;
      }
      return markedModule;
    }

    async function summarizeContent() {
      const options = {
        sharedContext:
          "Este es un artÃ­culo para desarrolladores FrontEnd, usa el mismo idioma que el texto para el resumen, el autor es Giorgiosaud y el tono es menos formal pero tÃ©cnico",
        type: "teaser",
        format: "markdown",
        length: "medium",
        expectedInputLanguages: [t.inputLang],
        outputLanguage: t.outputLang,
        monitor(m) {
          m.addEventListener("downloadprogress", (e) => {
            console.log(`Downloaded ${e.loaded * 100}%`);
          });
        },
      };

      const availability = await Summarizer.availability();
      if (availability !== "available") {
        summaryContent.innerHTML = `<p>${t.unavailable}</p>`;
      }

      summaryContent.innerHTML = `<p>${t.loading}</p>`;
      summaryModal.classList.add("show");

      // Lazy load marked only when actually summarizing
      const marked = await getMarked();

      const summarizer = await Summarizer.create(options);
      const text = document.getElementById("content").innerText;
      const summary = await summarizer.summarizeStreaming(text, {
        language: t.streamLang,
      });
      let result = "";
      for await (const chunk of summary.values()) {
        result += chunk;
        summaryContent.innerHTML = marked.parse(result);
      }
    }

    summaryBubble.addEventListener("click", () => {
      summaryModal.classList.add("show");
      summarizeContent();
    });

    closeModalBtn.addEventListener("click", () => {
      summaryModal.classList.remove("show");
      summaryContent.innerHTML = "";
    });

    // Close modal on outside click
    summaryModal.addEventListener("click", (e) => {
      if (e.target === summaryModal) {
        summaryModal.classList.remove("show");
        summaryContent.innerHTML = "";
      }
    });
  }
</script>

<style>
  .summary-bubble {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ff00cc, #3333ff, #00ffcc, #ffcc00);
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 2rem;
    cursor: pointer;
    z-index: 2000;
    border: none;
    transition: transform 0.2s;
    anchor-name: --summary-bot;
  }

  .summary-bubble:hover {
    transform: scale(1.1);
  }

  .summary-modal {
    position: fixed;
    position-anchor: --summary-bot;
    position-area: top left;
    max-width: 400px;
    width: 90vw;
    background: #fff;
    border-radius: 1.5rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
    padding: 2rem 1.5rem 1.5rem 1.5rem;
    z-index: 2100;
    display: none;
    flex-direction: column;
    gap: 1rem;
    animation: bubbleIn 0.3s ease;
    width: 280px;
  }
  code {
    background: #f4f4f4;
    padding: 0.2rem 0.4rem;
    border-radius: 0.3rem;
  }
  .summary-modal.show {
    display: flex;
  }

  .close-summary-modal {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #333;
    cursor: pointer;
  }

  #summary-content {
    font-size: 1rem;
    color: #222;
  }

  @media screen and (width > 500px) {
    .summary-modal {
      width: 100%;
    }
  }
  @keyframes bubbleIn {
    from {
      opacity: 0;
      transform: translateY(40px) scale(0.9);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
</style>
